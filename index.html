<!doctype html>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Flashcards â€” Decks</title>
<style>
  body { font: 16px -apple-system, system-ui, sans-serif; margin: 18px; }
  h1 { font-size: 22px; margin: 0 0 10px; }
  .sub { opacity:.7; margin: 0 0 14px; }
  .deck { display:block; padding:14px 14px; border:1px solid #ccc; border-radius:14px; text-decoration:none; color:inherit; margin: 10px 0; }
  .name { font-weight:700; font-size:18px; }
  .desc { opacity:.75; margin-top:6px; }
  .pill { display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid #ddd; opacity:.8; font-size:12px; margin-top:10px; }
</style>

<h1>Decks</h1>
<p class="sub">Tap a deck to start. (Progress is saved per deck on this device.)</p>

<div id="list"></div>
<p id="err" class="sub"></p>

<script>
  // Loads /decks/index.json and renders links to flashcard.html?d=<folder>
  async function loadDeckIndex() {
    const list = document.getElementById("list");
    const err = document.getElementById("err");

    try {
      const res = await fetch("decks/index.json", { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      if (!Array.isArray(data)) throw new Error("decks/index.json must be an array");

      // Validate folder names: alphanumeric + underscore + dash only
      const okName = (s) => /^[A-Za-z0-9_-]+$/.test(s);

      const decks = data.filter(d =>
        d && typeof d.folder === "string" && okName(d.folder) &&
        typeof d.title === "string" && d.title.trim().length
      );

      if (!decks.length) {
        err.textContent = "No decks found in decks/index.json.";
        return;
      }

      list.innerHTML = decks.map(d => {
        const title = escapeHtml(d.title.trim());
        const desc  = d.desc ? escapeHtml(String(d.desc)) : "";
        const count = d.count ? `<div class="pill">${escapeHtml(String(d.count))} cards</div>` : "";
        return `
          <a class="deck" href="flashcard.html?d=${encodeURIComponent(d.folder)}">
            <div class="name">${title}</div>
            ${desc ? `<div class="desc">${desc}</div>` : ""}
            ${count}
          </a>
        `;
      }).join("");

    } catch (e) {
      err.textContent = "Could not load decks/index.json: " + e.message;
    }
  }

  function escapeHtml(str) {
    return str.replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  loadDeckIndex();
</script>
